<a
  href="{{ routes.search_url }}"
  class="button"
  onclick="event.preventDefault(); event.stopPropagation(); document.getElementById('predictive_search')?.getAttribute('open') ? document.getElementById('predictive_search')?.close() : document.getElementById('predictive_search')?.showModal()"
>
  Search
</a>

<dialog scroll-lock id="predictive_search" closedby="any" class="right-0 left-0 max-h-dvh w-screen max-w-none">
  <div class="relative z-2 w-full justify-center bg-white px-4 overscroll-contain">
    <div x-data="predictiveSearch" class="mx-auto grid max-h-dvh w-full max-w-3xl grid-rows-[auto_1fr] md:pb-40">
      <form
        @submit.prevent="handleFormSubmit"
        action="{{ routes.search_url }}"
        class="sticky top-0 mb-6 flex items-center gap-2 border-b border-gray-400 bg-white pt-5 md:pt-30"
      >
        <div class="w-4 opacity-50">
          {% render 'icon-magnifier' %}
        </div>

        <input
          class="w-full py-2 text-base uppercase focus:outline-0"
          type="text"
          placeholder="Search products and pages"
          autofocus
          name="q"
          x-model="q"
          x-ref="input"
          @input.debounced="$refs.predictiveSearchForm.requestSubmit()"
        >

        <button type="button" aria-label="Close search" class="button w-4" onclick="this.closest('dialog')?.close()">
          {% render 'icon-cross' %}
        </button>

        <input type="hidden" name="type" value="product,page">
        <input type="hidden" name="options[unavailable_products]" value="hide">
        <input type="hidden" name="options[prefix]" value="last">
      </form>

      <form
        class="sr-only"
        x-ref="predictiveSearchForm"
        action="{{ routes.predictive_search_url }}"
        x-target="predictive-search-results"
        @ajax:before="
          if(!q) {
            $event.preventDefault()
            $refs.predictiveSearchResults.firstElementChild?.firstElementChild?.remove()
          }
        "
        @ajax:after="
          if(!q) {
            $event.preventDefault()
            $refs.predictiveSearchResults.firstElementChild?.firstElementChild?.remove()
          }
        "
      >
        <input type="search" name="q" x-model="q">
        <input type="hidden" name="section_id" value="predictive-search-results">
        <input type="hidden" name="type" value="product,page">
        <input type="hidden" name="options[unavailable_products]" value="hide">
        <input type="hidden" name="options[prefix]" value="last">
      </form>

      <div x-show="q !== ''" x-ref="predictiveSearchResults" class="">
        <output id="predictive-search-results" x-merge="update" class="bg-white pb-4"> </output>
      </div>
    </div>
  </div>
</dialog>

{% stylesheet %}
  dialog#predictive_search[open] {
    transform: translateY(0);
  }

  dialog#predictive_search {
    --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);

    transform: translateY(-100%);
    transition: all 500ms var(--ease-in-out) allow-discrete;
  }

  @starting-style {
    dialog#predictive_search[open] {
      transform: translateY(-100%);
    }
  }

  dialog#predictive_search::backdrop {
    background-color: transparent;
    transition: all 500ms var(--ease-in-out) allow-discrete;
  }

  dialog#predictive_search[open]::backdrop {
    background-color: rgb(0 0 0 / 25%);
  }

  @starting-style {
    dialog#predictive_search[open]::backdrop {
      background-color: transparent;
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Predictive search",
  "presets": [
    {
      "name": "Predictive search"
    }
  ]
}
{% endschema %}
